# Ansible role that setup the firewall policy.
# Actions performed:
# - Check input variables
# - Optionally disable IPv6
# - Disable ufw and firewalld
# - Setup iptables rules according to node's role from templates (idempotently).
# - Optionally setup allow-hostname script to allow connections from a ddns hostname.
#
# TODO: Testing for Redhat family
---

# Check cndeploy_nodes list for correct values
- name: 'Check variables: cndeploy_nodes.management_ip'
  ansible.builtin.assert:
    fail_msg: >
      Invalid value -> cndeploy_nodes.management_ip must contain valid IPv4 addresses.
    quiet: true
    that:
      - item.management_ip|ansible.utils.ipv4
  loop: '{{ cndeploy_nodes }}'
  when: cndeploy_nodes is defined

- name: 'Check variables: cndeploy_nodes.node_ip'
  ansible.builtin.assert:
    fail_msg: >
      Invalid value -> cndeploy_nodes.node_ip must contain valid IPv4 addresses.
    quiet: true
    that:
      - item.node_ip|ansible.utils.ipv4
  loop: '{{ cndeploy_nodes }}'
  when: cndeploy_nodes is defined

- name: 'Check variables: cndeploy_nodes.port'
  ansible.builtin.assert:
    fail_msg: >
      Invalid value -> cndeploy_nodes.port must be an integer between 1 and 65535.
    quiet: true
    that:
      - item.port|default(3001)|int != 0
      - item.port|default(3001)|int >= 1
      - item.port|default(3001)|int <= 65535
  loop: '{{ cndeploy_nodes }}'
  when: cndeploy_nodes is defined

- name: 'Check variables: cndeploy_nodes.prio'
  ansible.builtin.assert:
    fail_msg: >
      Invalid value -> cndeploy_nodes.prio must be an integer between 1 and 99.
    quiet: true
    that:
      - item.prio|default(50)|int != 0
      - item.prio|default(50)|int >= 1
      - item.prio|default(50)|int <= 99
  loop: '{{ cndeploy_nodes }}'
  when: cndeploy_nodes is defined

- name: 'Check variables: cndeploy_nodes.type'
  ansible.builtin.assert:
    fail_msg: >
      Invalid value -> Valid type values are "relay", "active", "warm", "builder" and "standby".
    quiet: true
    that:
      - (item.type|default('standby')|lower == 'relay' or
         item.type|default('standby')|lower == 'active' or
         item.type|default('standby')|lower == 'warm' or
         item.type|default('standby')|lower == 'builder' or
         item.type|default('standby')|lower == 'standby')
  loop: '{{ cndeploy_nodes }}'
  when: cndeploy_nodes is defined

- name: 'Check variables: cndeploy_nodes.cores'
  ansible.builtin.assert:
    fail_msg: >
      Invalid value -> cores value must be an integer between 1 and 64.
    quiet: true
    that:
      - item.cores|default(2)|int is integer
      - item.cores|default(2)|int >= 1
      - item.cores|default(2)|int <= 64
  loop: '{{ cndeploy_nodes }}'
  when: cndeploy_nodes is defined

- name: 'Check variables: cndeploy_whitelist_ip'
  ansible.builtin.assert:
    fail_msg: >
      Invalid value -> cndeploy_whitelist_ip must contain valid IPv4 addresses.
    quiet: true
    that:
      - item|ansible.utils.ipv4
  loop: '{{ cndeploy_whitelist_ip }}'
  when: cndeploy_whitelist_ip is defined

- name: 'Check variables: cndeploy_blacklist_ip'
  ansible.builtin.assert:
    fail_msg: >
      Invalid value -> cndeploy_blacklist_ip must contain valid IPv4 addresses.
    quiet: true
    that:
      - item|ansible.utils.ipv4
  loop: '{{ cndeploy_blacklist_ip }}'
  when: cndeploy_blacklist_ip is defined

- name: 'Check variables: cndeploy_allowhostname'
  ansible.builtin.assert:
    fail_msg: >
      Invalid value -> allowhostname must be defined and resolve to an IPv4 address.
    quiet: true
    that:
      - cndeploy_allowhostname is defined
      - (lookup("dig", cndeploy_allowhostname) != 'NXDOMAIN')
  when: cndeploy_allowhostname_enabled|default(false)|bool

#Â Resolve other vars
- name: 'Resolve platform specific vars'
  include_vars: '{{ item }}'
  with_first_found:
    - files:
        - '{{ ansible_distribution }}-{{ ansible_distribution_version }}.yml'
        - '{{ ansible_distribution }}-{{ ansible_distribution_major_version }}.yml'
        - '{{ ansible_distribution }}-{{ ansible_distribution_release }}.yml'
        - '{{ ansible_distribution }}.yml'
        - '{{ ansible_os_family }}.yml'
      paths:
        - '{{ role_path }}/vars'
      skip: true

- name: 'Resolve master IP'
  ansible.builtin.set_fact:
    master_ip: '{{ ansible_env["SSH_CLIENT"].split() | first }}'

- name: 'Show master IP (origin of current connection)'
  ansible.builtin.debug:
    msg: '{{ master_ip }}'

- name: 'Resolve SSH host IP'
  # hostvars[inventory_hostname]['ansible_env'].SSH_CONNECTION.split(' ')[2]
  ansible.builtin.set_fact:
    ssh_host_ip: '{{ ansible_env["SSH_CONNECTION"].split(" ")[2] }}'

- name: 'Show SSH host IP (destination of current connection)'
  ansible.builtin.debug:
    msg: '{{ ssh_host_ip }}'

- name: 'Get node ip from nodes definition'
  ansible.builtin.set_fact:
    cndeploy_node_ip: '{{ item.node_ip }}'
  loop: '{{ cndeploy_nodes }}'
  when: item.management_ip == ssh_host_ip

- name: 'Show cndeploy_node_ip'
  ansible.builtin.debug:
    msg: '{{ cndeploy_node_ip }}'

- name: 'Get node port from nodes definition'
  ansible.builtin.set_fact:
    cndeploy_node_port: '{{ item.port }}'
  loop: '{{ cndeploy_nodes }}'
  when: item.management_ip == ssh_host_ip

- name: 'Show cndeploy_node_port'
  ansible.builtin.debug:
    msg: '{{ cndeploy_node_port }}'

- name: 'Get node type from nodes definition'
  ansible.builtin.set_fact:
    cndeploy_node_type: '{{ item.type }}'
  loop: '{{ cndeploy_nodes }}'
  when: item.management_ip == ssh_host_ip

- name: 'Show cndeploy_node_type'
  ansible.builtin.debug:
    msg: '{{ cndeploy_node_type }}'

# Actions
- name: 'Install dependencies for the OS'
  ansible.builtin.package:
    name: '{{ cndeploy_pkgs_dep|default([]) }}'
    state: 'present'
  become: true
  become_user: 'root'

- name: 'Disable IPv6'
  ansible.posix.sysctl: name={{ item }} value=1 state=present reload=yes
  become: yes
  become_user: 'root'
  with_items:
    - net.ipv6.conf.all.disable_ipv6
    - net.ipv6.conf.default.disable_ipv6
    - net.ipv6.conf.lo.disable_ipv6
  when: cndeploy_disable_ipv6|default(false)|bool

- name: 'Setup firewall'
  # Ensure that the only firewall active is iptables as we require an idempotent
  # set of rules by flushing and loading from file at each execution.
  become: yes
  become_user: 'root'
  when: cndeploy_firewall_enabled|default(false)|bool
  block:
    - name: 'If iptables is available, proceed to setup firewalls...'
      ansible.builtin.stat:
        path: '/usr/sbin/iptables'
      register: iptables
    - name: 'Iptables is available, proceed to setup firewalls...'
      when: iptables.stat.exists
      block:
        - name: 'Disable UFW and enable netfilter-persistent'
          when: ansible_os_family == "Debian"
          block:
            - name: 'Disable UFW'
              ansible.builtin.systemd:
                name: 'ufw.service'
                state: 'stopped'
                enabled: false
              #community.general.ufw:
              #  state: 'disabled'
            - name: 'Enable netfilter-persistent'
              ansible.builtin.systemd:
                enabled: true
                name: 'netfilter-persistent.service'
                state: 'started'
        - name: 'Disable firewalld and enable iptables'
          when: ansible_os_family == "Redhat"
          block:
            - name: 'Disable firewalld'
              ansible.builtin.systemd:
                enabled: false
                masked: true
                name: 'firewalld.service'
                state: 'stopped'
            - name: 'Enable iptables'
              ansible.builtin.systemd:
                enabled: true
                name: 'iptables.service'
                state: 'started'
        - name: 'Activate Forwarding'
          ansible.posix.sysctl:
            name: 'net.ipv4.ip_forward'
            value: '1'
            sysctl_set: yes
            state: 'present'
            reload: true
        - name: 'Activate Forwarding from localhost'
          ansible.posix.sysctl:
            name: 'net.ipv4.conf.all.route_localnet'
            value: '1'
            sysctl_set: yes
            state: 'present'
            reload: true
        - name: 'Deploy iptables rules for Debian family'
          when: ansible_os_family == "Debian"
          block:
            - name: 'Deploy IP4 BP rules from template for Debian family'
              ansible.builtin.template:
                dest: '/etc/iptables/rules.v4'
                mode: '0644'
                src: 'iptables-rules-4-bp.j2'
              notify: 'Apply IP4 rules from file for Debian family'
              when: cndeploy_node_type|default('standby')|lower == 'active' or
                    cndeploy_node_type|default('standby')|lower == 'warm'
            - name: 'Deploy IP4 Relay rules from template for Debian family'
              ansible.builtin.template:
                dest: '/etc/iptables/rules.v4'
                mode: '0644'
                src: 'iptables-rules-4-relay.j2'
              notify: 'Apply IP4 rules from file for Debian family'
              when: cndeploy_node_type|default('standby')|lower == 'relay'
            - name: 'Deploy IP4 Standby rules from template for Debian family'
              ansible.builtin.template:
                dest: '/etc/iptables/rules.v4'
                mode: '0644'
                src: 'iptables-rules-4-standby.j2'
              notify: 'Apply IP4 rules from file for Debian family'
              when: cndeploy_node_type|default('standby')|lower == 'standby'
            - name: 'Deploy IP6 rules from template for Debian family'
              ansible.builtin.template:
                dest: '/etc/iptables/rules.v6'
                mode: '0644'
                src: 'iptables-rules-6.j2'
              notify: 'Apply IP6 rules from file for Debian family'
        - name: 'Deploy iptables rules for Redhat family'
          when: ansible_os_family == "Redhat"
          block:
            - name: 'Deploy IP4 BP rules from template for Redhat family'
              ansible.builtin.template:
                dest: '/etc/sysconfig/iptables'
                mode: '0644'
                src: 'iptables-rules-4-bp.j2'
              notify: 'Apply IP4 rules from file for Redhat family'
              when: cndeploy_node_type|default('standby')|lower == 'active' or
                    cndeploy_node_type|default('standby')|lower == 'warm'
            - name: 'Deploy IP4 Relay rules from template for Redhat family'
              ansible.builtin.template:
                dest: '/etc/sysconfig/iptables'
                mode: '0644'
                src: 'iptables-rules-4-relay.j2'
              notify: 'Apply IP4 rules from file for Redhat family'
              when: cndeploy_node_type|default('standby')|lower == 'relay'
            - name: 'Deploy IP4 Standby rules from template for Redhat family'
              ansible.builtin.template:
                dest: '/etc/sysconfig/iptables'
                mode: '0644'
                src: 'iptables-rules-4-standby.j2'
              notify: 'Apply IP4 rules from file for Redhat family'
              when: cndeploy_node_type|default('standby')|lower == 'standby'
            - name: 'Deploy IP6 rules from template for Redhat family'
              ansible.builtin.template:
                dest: '/etc/sysconfig/ip6tables'
                mode: '0644'
                src: 'iptables-rules-6.j2'
              notify: 'Apply IP6 rules from file for Redhat family'

- name: 'Setup allow-hostname in iptables mode'
  become: true
  become_user: 'root'
  when:
    - cndeploy_allowhostname_enabled|default(false)|bool
    - cndeploy_allowhostname is defined
  block:
    - name: 'Check if allow-hostname script already exists'
      # required as get_url not always behaves like described in its documentation,
      # overwriting the file when it exists, even with force:no and dest being the full file path
      ansible.builtin.stat:
        get_checksum: false
        get_md5: false
        path: '/usr/local/bin/allow-hostname.bash'
      changed_when: false
      register: allowhostname_file_check
    - name: 'Download allow-hostname script'
      ansible.builtin.get_url:
        dest: '/usr/local/bin/allow-hostname.bash'
        force: false
        mode: '0700'
        url: 'https://raw.githubusercontent.com/jmhoms/allow-hostname/master/allow-hostname.bash'
      when: not allowhostname_file_check.stat.exists
    - name: 'Configure defined hostname in the script'
      ansible.builtin.lineinfile:
        dest: '/usr/local/bin/allow-hostname.bash'
        line: 'HOSTNAME={{ cndeploy_allowhostname }}'
        regexp: '^HOSTNAME='
        state: 'present'
    - name: 'Configure iptables mode in the script'
      ansible.builtin.lineinfile:
        dest: '/usr/local/bin/allow-hostname.bash'
        line: 'IPTMODE=yes'
        regexp: '^IPTMODE='
        state: 'present'
    - name: 'Configure cron to run the script every 5 minutes'
      ansible.builtin.copy:
        content: |
          */5 * * * * root /usr/local/bin/allow-hostname.bash 2>&1 | logger -t allow-hostname
        dest: '/etc/cron.d/allow-hostname'
        group: 'root'
        mode: '0644'
        owner: 'root'
