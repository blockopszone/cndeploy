*nat
:PREROUTING ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
{% if cndeploy_nodes|default("") is not none %}
{{ active_node_ip = (cndeploy_nodes|selectattr('type', 'eq', 'active')|sort(attribute="prio")|first).node_ip }}
{{ active_port = (cndeploy_nodes|selectattr('type', 'eq', 'active')|sort(attribute="prio")|first).port }}
{% if active_node_ip|ipv4 and active_port|int>=1 and active_port|int<=65535 %}
-A OUTPUT -m addrtype --src-type LOCAL --dst-type LOCAL -p tcp --dport 6000 -j DNAT --to-destination {{ active_node_ip }}:{{ active_port }}
-A POSTROUTING -m addrtype --src-type LOCAL --dst-type UNICAST -j MASQUERADE
{% endif %}
{% endif %}
COMMIT

*filter
:INPUT DROP [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
-A INPUT -i lo -j ACCEPT
-A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
{% if cndeploy_blacklist_ip|default("") is not none %}
{% for bl_ip in cndeploy_blacklist_ip %}
-A INPUT -s {{ bl_ip }} -j DROP
-A OUTPUT -d {{ bl_ip }} -j DROP
{% endfor %}
{% endif %}
-A INPUT -p tcp --dport {{ cndeploy_node_port }} -m conntrack --ctstate NEW -j ACCEPT
{% if cndeploy_management_ip|default("") is not none %}
{% for mng_ip in cndeploy_management_ip %}
-A INPUT -p tcp -s {{ mng_ip }} --dport 22 -m conntrack --ctstate NEW -j ACCEPT
{% endfor %}
{% endif %}
-A INPUT -p tcp -s {{ master_ip }} --dport 22 -m conntrack --ctstate NEW -j ACCEPT
-A INPUT -m limit --limit 5/min -j LOG --log-prefix "iptables denied: " --log-level 7
COMMIT
