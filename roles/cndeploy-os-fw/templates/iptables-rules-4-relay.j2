*nat
:PREROUTING ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
{% if cndeploy_bp_nodes|default("") is not none %}
{% for item in cndeploy_bp_nodes %}
{% if item.role|lower == "active" %}
-A OUTPUT -m addrtype --src-type LOCAL --dst-type LOCAL -p tcp --dport 6000 -j DNAT --to-destination {{ item.ip }}:{{ item.port }}
-A POSTROUTING -m addrtype --src-type LOCAL --dst-type UNICAST -j MASQUERADE
{% endif %}
{% endfor %}
{% endif %}
COMMIT

*filter
:INPUT DROP [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
-A INPUT -i lo -j ACCEPT
-A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
{% if cndeploy_blacklist_ip|default("") is not none %}
{% for bl_ip in cndeploy_blacklist_ip %}
-A INPUT -s {{ bl_ip }} -j DROP
-A OUTPUT -d {{ bl_ip }} -j DROP
{% endfor %}
{% endif %}
-A INPUT -p tcp --dport {{ cndeploy_node_port }} -m conntrack --ctstate NEW -j ACCEPT
{% if cndeploy_management_ip|default("") is not none %}
{% for mng_ip in cndeploy_management_ip %}
-A INPUT -p tcp -s {{ mng_ip }} --dport 22 -m conntrack --ctstate NEW -j ACCEPT
{% endfor %}
{% endif %}
-A INPUT -p tcp -s {{ master_ip }} --dport 22 -m conntrack --ctstate NEW -j ACCEPT
-A INPUT -m limit --limit 5/min -j LOG --log-prefix "iptables denied: " --log-level 7
COMMIT
